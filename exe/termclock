#!/usr/bin/env ruby
require 'termclock'

$-v = true

if ARGV.any? { |x| x[/\A\-(\-help|h)\z/] }
	puts <<~EOF
		TermClock: A clock that runs on the LinuxTerminal!

		Arguments:
			--help|-h\t\t\tShows this help section
			--character=|char=\t\tDraws specified character
			--colour=|-c=\t\t\tSpecify hex colour (4 colours)
			\t\t\t\t[ with or without # ]
			--clean\t\t\t\tJust run the clean bare clock
			--no-sysinfo|-ni\t\tShows no system info
			--no-date|-nd\t\t\tShows no date
			--no-message|-nm\t\tShows no messages
	EOF

	exit 0
end

begin
	print "\e[?25l"

	arg_col = ARGV.find { |x| x[/\A\-(\-colour|\-color|c|)=.*\z/] } &.split(?=) &.at(1) &.split(?,)

	colours = if arg_col
		abort("4 colours are needed. Example: -c=f55,55f,55f,3eb") if arg_col.length != 4
		arg_col
	else
		%w(ff5555 5555ff 5555ff 33eebb)
	end

	colours.map! { |x|
		begin
			Termclock.hex2rgb(x)
		rescue ArgumentError
			abort $!.to_s
		end
	}

	chars = ARGV.find { |x| x[/\A\-(\-character|char)=.*\z/] } &.split(?=) &.at(1)
	Termclock::ParseCharacters.transform_characters!(*chars) if chars

	_refresh_time = ARGV.find { |x| x[/\A\-(\-refresh|r)=.*\z/] } &.split(?=) &.at(1)
	refresh_time = _refresh_time ? _refresh_time.to_f : 0.1

	text_colours = ARGV.find { |x| x[/\A\-(\-text\-colour|tc)=.*\z/] } &.split(?=) &.at(1) &.split(?,)
	abort("Text colours need 2 colours. Example: -tc=55f,3ce3b5") if text_colours && text_colours.length != 2

	bold = ARGV.any? { |x| x[/\A\-\-bold\z/] }
	no_print_info = ARGV.any? { |x| x[/\A\-(\-no\-sysinfo|ni)\z/] }
	no_print_message = ARGV.any? { |x| x[/\A\-(\-no\-message|nm)\z/] }
	no_print_date = ARGV.any? { |x| x[/\A\-(\-no\-date|nd)\z/] }

	clean = ARGV.any? { |x| x[/\A\-(\-clean)\z/] }

	if clean
		no_print_info = no_print_message = no_print_date = true
	end

	Termclock.start(
		*colours,
		*text_colours,
		sleep: refresh_time,
		bold: bold,
		print_info: !no_print_info,
		print_message: !no_print_message,
		print_date: !no_print_date
	)
rescue Interrupt, SignalException
	print "\e[H\e[2J\e[3J"
ensure
	print "\e[?25h"
end
